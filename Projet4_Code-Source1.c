#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>
#include <sys/wait.h>
#include<sys/types.h>

/*Projet4.a/b*/
/*Implémenter le schema explicatif de communication des n processus créés. 
Ecrire un programme qui met en place cette structure de processus et les connexions correspondantes. 
Ce programme recevra un unique argument : le nombre n de processus de l’anneau*/
/*@mahahanafi*/
int main(int argc, char const *argv[]) 
{
pid_t pid;
int nbprocessus = 4;
int p[nbprocessus][2];
int i,j;
//*****
printf("On a %d Processes \n", nbprocessus);
//creation du pipe 
     for(i=0; i<nbprocessus; i++)
{
       pipe(p[i]);
}
     for(i=0; i<nbprocessus; i++)
{    //creation de processus après la création du pipe
     pid = fork();

     if (pid<0)
     {
          perror("error fork");
          exit(2);
     }
     /*D'après le schema explicatif l’entrée standard (stdin) et la sortie standard (stdout) de chaque processus Pi sont
     redirigées vers les tubes appropriés.Par exemple, pour le processus P0, l’entrée et la sortie
     standards deviennent respectivement les tubes tub3 et tub0. */
     else if (pid ==0) //fils
          {
          printf("PID de processus fils: %d son père est : %d \n",  getpid(), getppid());
          dup2(p[i][1],1); //L'entrée est vers pipe du gauche 
          dup2(p[(nbprocessus+i-1)%nbprocessus][0],0); //La sortie est vers pipe du droit
          for(j=0; j<nbprocessus; j++)
          {
               close(p[j][0]); //fermeture du pipe de lecture
               close(p[j][1]); //fermeture du pipe d'ecriture 
          }
             exit(0);
          } exit(0);
}
  return 0;
}